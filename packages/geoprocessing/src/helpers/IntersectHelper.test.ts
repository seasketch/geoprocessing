// @ts-ignore
import { Sketch } from "../index";
import {
  getSketchIntersectList,
  intersect,
  getIntersectList,
} from "./IntersectHelper";

//testing intersection of 2 sketches that don't overlap
test("getIntersectListWithMulti", async () => {
  const coll2 = featureCollectionWithMultiPolygon;
  const coll = featureCollection;
  //@ts-ignore
  let ints = getIntersectList(coll, coll2, []);
  expect(ints.type).toEqual("FeatureCollection");
  expect(ints.features.length).toEqual(4);
});

//testing intersection of 2 sketches that don't overlap
test("getSketchIntersectList", async () => {
  const sketch = poly1;
  const coll = featureCollection;
  //@ts-ignore
  let ints = getSketchIntersectList(sketch, coll, []);
  expect(ints.type).toEqual("FeatureCollection");
  expect(ints.features.length).toEqual(2);
});

//testing intersection of polygon to polygon
test("intersectPolyToPoly", async () => {
  const singlePolygon1 = poly1;
  const singlePolygon2 = poly2;
  //@ts-ignore
  let ints = intersect(singlePolygon1, singlePolygon2);
  let coords = ints?.geometry.coordinates;

  expect(coords?.length).toEqual(1);
});

//testing multipolygon with polygon
test("intersectMultiPolyToPoly", async () => {
  const mp1 = multiPolyWithHole;
  const mp2 = polygonWithHole2;
  //@ts-ignore
  let ints = intersect(mp1, mp2);
  let coords = ints?.geometry.coordinates;
  if (coords && coords[0]) {
    expect(coords[0].length).toEqual(20);
  }
});

//testing the branch of intersecting a polygon with a multipolygon
test("intersectPolyToMultiPoly", async () => {
  const mp2 = multiPolyWithHole;
  const mp1 = polygonWithHole2;
  //@ts-ignore
  let ints = intersect(mp1, mp2);
  let coords = ints?.geometry.coordinates;
  if (coords && coords[0]) {
    expect(coords[0].length).toEqual(20);
  }
});

//testing intersection of 2 multipolygons
test("intersectMultiPolyToMultiPoly", async () => {
  const mp1 = multiPolyWithHole;
  const mp2 = multiPolygonWithHole2;
  //@ts-ignore
  let ints = intersect(mp1, mp2);
  let coords = ints?.geometry.coordinates;
  if (coords && coords[0]) {
    expect(coords[0].length).toEqual(20);
    expect(ints?.geometry.type).toEqual("Polygon");
  }
});

//testing intersection of 2 sketches that don't overlap
test("noIntersection", async () => {
  const mp1 = poly1;
  const mp2 = multiPolygonWithHole2;
  //@ts-ignore
  let ints = intersect(mp1, mp2);
  console.info("ints: ", ints);
  expect(ints).toBeFalsy();
});

const poly1: Sketch = {
  type: "Feature",
  geometry: {
    type: "Polygon",
    coordinates: [
      [
        [-120.50761836929574, 34.15876420174093],
        [-120.47465938492077, 34.115570814580664],
        [-120.47399620874191, 34.076006734655316],
        [-120.56236292584192, 34.06915652321615],
        [-120.5900158302332, 34.15876420174093],
        [-120.50761836929574, 34.15876420174093],
      ],
    ],
    bbox: [
      -120.5900158302332,
      34.06915652321615,
      -120.47399620874191,
      34.15876420174093,
    ],
  },
  properties: {
    id: "5edfa42fa1a9956b48ece148",
    name: "ExampleProjectTest1",
    updatedAt: "2020-06-29T17:45:14.981Z",
    createdAt: "2020-06-09T15:01:03.420Z",
    sketchClassId: "5edfa3a8a1a9956b48ece131",
    isCollection: false,
    userAttributes: [],
  },
  bbox: [
    -120.5900158302332,
    34.06915652321615,
    -120.47399620874191,
    34.15876420174093,
  ],
};

const poly2 = {
  type: "Feature",
  geometry: {
    type: "Polygon",
    coordinates: [
      [
        [-120.5354392470266, 34.05454416537362],
        [-120.5237662733938, 34.1091399259457],
        [-120.45990824116733, 34.1438126884066],
        [-120.41115641011271, 34.07843414157968],
        [-120.52033304585474, 34.043165619062265],
        [-120.5354392470266, 34.05454416537362],
      ],
    ],
    bbox: [
      -120.5354392470266,
      34.043165619062265,
      -120.41115641011271,
      34.1438126884066,
    ],
  },
  properties: {
    id: "5f36d24ee4b52668b076b813",
    name: "ExampleProjectTest2",
    updatedAt: "2020-08-14T18:05:02.514Z",
    createdAt: "2020-08-14T18:05:02.514Z",
    sketchClassId: "5edfa3a8a1a9956b48ece131",
    isCollection: false,
    userAttributes: [],
  },
  bbox: [
    -120.5354392470266,
    34.043165619062265,
    -120.41115641011271,
    34.1438126884066,
  ],
};

let multiPolyWithHole = {
  type: "Feature",
  geometry: {
    type: "MultiPolygon",
    coordinates: [
      [
        [
          [-120.43381571154376, 34.064356935192514],
          [-120.42729257983676, 34.05440194313146],
          [-120.44102548940279, 34.04757498667908],
          [-120.44995188129445, 34.055255273661984],
          [-120.43381571154376, 34.064356935192514],
        ],
        [
          [-120.43869400011775, 34.058527999838624],
          [-120.43924999978644, 34.05836099961957],
          [-120.43977799986604, 34.058527999838624],
          [-120.44077799994874, 34.058221999845856],
          [-120.4415559993753, 34.057443999977195],
          [-120.44136099938163, 34.056528000349324],
          [-120.44083300020033, 34.05622199983438],
          [-120.43997200003479, 34.05511100022411],
          [-120.4389999995412, 34.05497200033058],
          [-120.43763899978346, 34.05408299965817],
          [-120.43716699978035, 34.05408299965817],
          [-120.4363609998664, 34.05355599979503],
          [-120.43477799945252, 34.05333299991437],
          [-120.43347199994636, 34.053472000262616],
          [-120.43269399962152, 34.054556000310036],
          [-120.43280599977453, 34.05502800027763],
          [-120.43355599961195, 34.05566699975183],
          [-120.43408299986665, 34.05705599985156],
          [-120.4343890001884, 34.057443999977195],
          [-120.43624999953833, 34.05766700020668],
          [-120.43727800010844, 34.057638999993145],
          [-120.43808300019747, 34.05838900033878],
          [-120.43869400011775, 34.058527999838624],
        ],
      ],
    ],
    bbox: [
      -120.44995188129445,
      34.04757498667908,
      -120.42729257983676,
      34.064356935192514,
    ],
  },
  properties: {
    id: "5f36f2d2187cc8125740b04f",
    name: "ExampleProjectIslandClip",
    updatedAt: "2020-08-14T20:23:46.119Z",
    createdAt: "2020-08-14T20:23:46.119Z",
    sketchClassId: "5edfa3a8a1a9956b48ece131",
    isCollection: false,
    userAttributes: [],
  },
  bbox: [
    -120.44995188129445,
    34.04757498667908,
    -120.42729257983676,
    34.064356935192514,
  ],
};

//overlaps with multiPolygonWithHole
let multiPolygonWithHole2 = {
  type: "Feature",
  geometry: {
    type: "MultiPolygon",
    coordinates: [
      [
        [
          [-120.42523264317728, 34.06321928067594],
          [-120.4342371507694, 34.057251459208736],
          [-120.4343890001884, 34.057443999977195],
          [-120.43624999953833, 34.05766700020668],
          [-120.43727800010844, 34.057638999993145],
          [-120.43808300019747, 34.05838900033878],
          [-120.43869400011775, 34.058527999838624],
          [-120.43924999978644, 34.05836099961957],
          [-120.43977799986604, 34.058527999838624],
          [-120.44077799994874, 34.058221999845856],
          [-120.4415559993753, 34.057443999977195],
          [-120.44136099938163, 34.056528000349324],
          [-120.44083300020033, 34.05622199983438],
          [-120.43997200003479, 34.05511100022411],
          [-120.4389999995412, 34.05497200033058],
          [-120.43833333281938, 34.054536536460205],
          [-120.45269846320764, 34.04501473665732],
          [-120.46128153247243, 34.05923737071085],
          [-120.4296958391231, 34.07061376015754],
          [-120.42523264317728, 34.06321928067594],
        ],
      ],
    ],
    bbox: [
      -120.46128153247243,
      34.04501473665732,
      -120.42523264317728,
      34.07061376015754,
    ],
  },
  properties: {
    id: "5f36f8a2187cc8125740b14a",
    name: "ExampleProjectIslandClip2",
    updatedAt: "2020-08-14T20:48:34.352Z",
    createdAt: "2020-08-14T20:48:34.352Z",
    sketchClassId: "5edfa3a8a1a9956b48ece131",
    isCollection: false,
    userAttributes: [],
  },
  bbox: [
    -120.46128153247243,
    34.04501473665732,
    -120.42523264317728,
    34.07061376015754,
  ],
};

//same as multiPolygonWithHole2, but its a single poly
//overlaps with multiPolygonWithHole
let polygonWithHole2 = {
  type: "Feature",
  geometry: {
    type: "Polygon",
    coordinates: [
      [
        [-120.42523264317728, 34.06321928067594],
        [-120.4342371507694, 34.057251459208736],
        [-120.4343890001884, 34.057443999977195],
        [-120.43624999953833, 34.05766700020668],
        [-120.43727800010844, 34.057638999993145],
        [-120.43808300019747, 34.05838900033878],
        [-120.43869400011775, 34.058527999838624],
        [-120.43924999978644, 34.05836099961957],
        [-120.43977799986604, 34.058527999838624],
        [-120.44077799994874, 34.058221999845856],
        [-120.4415559993753, 34.057443999977195],
        [-120.44136099938163, 34.056528000349324],
        [-120.44083300020033, 34.05622199983438],
        [-120.43997200003479, 34.05511100022411],
        [-120.4389999995412, 34.05497200033058],
        [-120.43833333281938, 34.054536536460205],
        [-120.45269846320764, 34.04501473665732],
        [-120.46128153247243, 34.05923737071085],
        [-120.4296958391231, 34.07061376015754],
        [-120.42523264317728, 34.06321928067594],
      ],
    ],
    bbox: [
      -120.46128153247243,
      34.04501473665732,
      -120.42523264317728,
      34.07061376015754,
    ],
  },
  properties: {
    id: "5f36f8a2187cc8125740b14a",
    name: "ExampleProjectIslandClip2",
    updatedAt: "2020-08-14T20:48:34.352Z",
    createdAt: "2020-08-14T20:48:34.352Z",
    sketchClassId: "5edfa3a8a1a9956b48ece131",
    isCollection: false,
    userAttributes: [],
  },
  bbox: [
    -120.46128153247243,
    34.04501473665732,
    -120.42523264317728,
    34.07061376015754,
  ],
};

//all of them in one collection
let featureCollection = {
  type: "FeatureCollection",
  properties: {
    id: "5f36f8d5187cc8125740b150",
    name: "ExampleProjectSketches",
    updatedAt: "2020-08-14T20:49:35.694Z",
    createdAt: "2020-08-14T20:49:25.640Z",
    sketchClassId: "5f36f8c1187cc8125740b14b",
    isCollection: true,
    userAttributes: [],
  },
  features: [
    {
      type: "Feature",
      geometry: {
        type: "Polygon",
        coordinates: [
          [
            [-120.50761836929574, 34.15876420174093],
            [-120.47465938492077, 34.115570814580664],
            [-120.47399620874191, 34.076006734655316],
            [-120.56236292584192, 34.06915652321615],
            [-120.5900158302332, 34.15876420174093],
            [-120.50761836929574, 34.15876420174093],
          ],
        ],
        bbox: [
          -120.5900158302332,
          34.06915652321615,
          -120.47399620874191,
          34.15876420174093,
        ],
      },
      properties: {
        id: "5edfa42fa1a9956b48ece148",
        name: "ExampleProjectTest1",
        updatedAt: "2020-08-14T20:49:32.197Z",
        createdAt: "2020-06-09T15:01:03.420Z",
        sketchClassId: "5edfa3a8a1a9956b48ece131",
        isCollection: false,
        userAttributes: [],
      },
      bbox: [
        -120.5900158302332,
        34.06915652321615,
        -120.47399620874191,
        34.15876420174093,
      ],
    },
    {
      type: "Feature",
      geometry: {
        type: "Polygon",
        coordinates: [
          [
            [-120.5354392470266, 34.05454416537362],
            [-120.5237662733938, 34.1091399259457],
            [-120.45990824116733, 34.1438126884066],
            [-120.41115641011271, 34.07843414157968],
            [-120.52033304585474, 34.043165619062265],
            [-120.5354392470266, 34.05454416537362],
          ],
        ],
        bbox: [
          -120.5354392470266,
          34.043165619062265,
          -120.41115641011271,
          34.1438126884066,
        ],
      },
      properties: {
        id: "5f36d24ee4b52668b076b813",
        name: "ExampleProjectTest2",
        updatedAt: "2020-08-14T20:49:32.159Z",
        createdAt: "2020-08-14T18:05:02.514Z",
        sketchClassId: "5edfa3a8a1a9956b48ece131",
        isCollection: false,
        userAttributes: [],
      },
      bbox: [
        -120.5354392470266,
        34.043165619062265,
        -120.41115641011271,
        34.1438126884066,
      ],
    },
    {
      type: "Feature",
      geometry: {
        type: "Polygon",
        coordinates: [
          [
            [-120.43381571154376, 34.064356935192514],
            [-120.42729257983676, 34.05440194313146],
            [-120.44102548940279, 34.04757498667908],
            [-120.44995188129445, 34.055255273661984],
            [-120.43381571154376, 34.064356935192514],
          ],
          [
            [-120.43869400011775, 34.058527999838624],
            [-120.43924999978644, 34.05836099961957],
            [-120.43977799986604, 34.058527999838624],
            [-120.44077799994874, 34.058221999845856],
            [-120.4415559993753, 34.057443999977195],
            [-120.44136099938163, 34.056528000349324],
            [-120.44083300020033, 34.05622199983438],
            [-120.43997200003479, 34.05511100022411],
            [-120.4389999995412, 34.05497200033058],
            [-120.43763899978346, 34.05408299965817],
            [-120.43716699978035, 34.05408299965817],
            [-120.4363609998664, 34.05355599979503],
            [-120.43477799945252, 34.05333299991437],
            [-120.43347199994636, 34.053472000262616],
            [-120.43269399962152, 34.054556000310036],
            [-120.43280599977453, 34.05502800027763],
            [-120.43355599961195, 34.05566699975183],
            [-120.43408299986665, 34.05705599985156],
            [-120.4343890001884, 34.057443999977195],
            [-120.43624999953833, 34.05766700020668],
            [-120.43727800010844, 34.057638999993145],
            [-120.43808300019747, 34.05838900033878],
            [-120.43869400011775, 34.058527999838624],
          ],
        ],
        bbox: [
          -120.44995188129445,
          34.04757498667908,
          -120.42729257983676,
          34.064356935192514,
        ],
      },
      properties: {
        id: "5f36f2d2187cc8125740b04f",
        name: "ExampleProjectIslandClip",
        updatedAt: "2020-08-14T20:49:35.694Z",
        createdAt: "2020-08-14T20:23:46.119Z",
        sketchClassId: "5edfa3a8a1a9956b48ece131",
        isCollection: false,
        userAttributes: [],
      },
      bbox: [
        -120.44995188129445,
        34.04757498667908,
        -120.42729257983676,
        34.064356935192514,
      ],
    },
    {
      type: "Feature",
      geometry: {
        type: "Polygon",
        coordinates: [
          [
            [-120.42523264317728, 34.06321928067594],
            [-120.4342371507694, 34.057251459208736],
            [-120.4343890001884, 34.057443999977195],
            [-120.43624999953833, 34.05766700020668],
            [-120.43727800010844, 34.057638999993145],
            [-120.43808300019747, 34.05838900033878],
            [-120.43869400011775, 34.058527999838624],
            [-120.43924999978644, 34.05836099961957],
            [-120.43977799986604, 34.058527999838624],
            [-120.44077799994874, 34.058221999845856],
            [-120.4415559993753, 34.057443999977195],
            [-120.44136099938163, 34.056528000349324],
            [-120.44083300020033, 34.05622199983438],
            [-120.43997200003479, 34.05511100022411],
            [-120.4389999995412, 34.05497200033058],
            [-120.43833333281938, 34.054536536460205],
            [-120.45269846320764, 34.04501473665732],
            [-120.46128153247243, 34.05923737071085],
            [-120.4296958391231, 34.07061376015754],
            [-120.42523264317728, 34.06321928067594],
          ],
        ],
        bbox: [
          -120.46128153247243,
          34.04501473665732,
          -120.42523264317728,
          34.07061376015754,
        ],
      },
      properties: {
        id: "5f36f8a2187cc8125740b14a",
        name: "ExampleProjectIslandClip2",
        updatedAt: "2020-08-14T20:49:35.695Z",
        createdAt: "2020-08-14T20:48:34.352Z",
        sketchClassId: "5edfa3a8a1a9956b48ece131",
        isCollection: false,
        userAttributes: [],
      },
      bbox: [
        -120.46128153247243,
        34.04501473665732,
        -120.42523264317728,
        34.07061376015754,
      ],
    },
  ],
};

let featureCollectionWithMultiPolygon = {
  type: "FeatureCollection",
  properties: {
    id: "5f370488187cc8125740b177",
    name: "ExampleProjectCollection2",
    updatedAt: "2020-08-14T21:40:11.176Z",
    createdAt: "2020-08-14T21:39:20.514Z",
    sketchClassId: "5f36f8c1187cc8125740b14b",
    isCollection: true,
    userAttributes: [],
  },
  features: [
    {
      type: "Feature",
      geometry: {
        type: "MultiPolygon",
        coordinates: [
          [
            [
              [-120.42900919297107, 34.061086138315254],
              [-120.43587564820324, 34.04515697512842],
              [-120.54985880254196, 34.09407273844459],
              [-120.52925943774376, 34.102033096332526],
              [-120.42900919297107, 34.061086138315254],
            ],
            [
              [-120.43869400011775, 34.058527999838624],
              [-120.43924999978644, 34.05836099961957],
              [-120.43977799986604, 34.058527999838624],
              [-120.44077799994874, 34.058221999845856],
              [-120.4415559993753, 34.057443999977195],
              [-120.44136099938163, 34.056528000349324],
              [-120.44083300020033, 34.05622199983438],
              [-120.43997200003479, 34.05511100022411],
              [-120.4389999995412, 34.05497200033058],
              [-120.43763899978346, 34.05408299965817],
              [-120.43716699978035, 34.05408299965817],
              [-120.4363609998664, 34.05355599979503],
              [-120.43477799945252, 34.05333299991437],
              [-120.43347199994636, 34.053472000262616],
              [-120.43269399962152, 34.054556000310036],
              [-120.43280599977453, 34.05502800027763],
              [-120.43355599961195, 34.05566699975183],
              [-120.43408299986665, 34.05705599985156],
              [-120.4343890001884, 34.057443999977195],
              [-120.43624999953833, 34.05766700020668],
              [-120.43727800010844, 34.057638999993145],
              [-120.43808300019747, 34.05838900033878],
              [-120.43869400011775, 34.058527999838624],
            ],
          ],
        ],
        bbox: [
          -120.54985880254196,
          34.04515697512842,
          -120.42900919297107,
          34.102033096332526,
        ],
      },
      properties: {
        id: "5f3704a5187cc8125740b179",
        name: "ExampleMayIntersectMulti",
        updatedAt: "2020-08-14T21:39:52.034Z",
        createdAt: "2020-08-14T21:39:49.280Z",
        sketchClassId: "5edfa3a8a1a9956b48ece131",
        isCollection: false,
        userAttributes: [],
      },
      bbox: [
        -120.54985880254196,
        34.04515697512842,
        -120.42900919297107,
        34.102033096332526,
      ],
    },
    {
      type: "Feature",
      geometry: {
        type: "Polygon",
        coordinates: [
          [
            [-120.67482828543186, 34.03491521850319],
            [-120.717400306434, 34.026948552754455],
            [-120.72564005307194, 34.05881072619131],
            [-120.68306803117146, 34.06222382072432],
            [-120.67482828543186, 34.03491521850319],
          ],
        ],
        bbox: [
          -120.72564005307194,
          34.026948552754455,
          -120.67482828543186,
          34.06222382072432,
        ],
      },
      properties: {
        id: "5f3704b5187cc8125740b17b",
        name: "ExampleNoIntersect",
        updatedAt: "2020-08-14T21:40:11.177Z",
        createdAt: "2020-08-14T21:40:05.447Z",
        sketchClassId: "5edfa3a8a1a9956b48ece131",
        isCollection: false,
        userAttributes: [],
      },
      bbox: [
        -120.72564005307194,
        34.026948552754455,
        -120.67482828543186,
        34.06222382072432,
      ],
    },
  ],
};
